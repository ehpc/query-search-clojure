(ns query-search.testing.fake-server
  "Сервер для тестирования API."
  (:require [clojure.string :as string]
            [org.httpkit.server :as server]
            [ring.middleware.defaults :as middleware]
            [query-search.settings :as settings]))


;;; Стандартный ответ API-сервера
(def response "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<rss xmlns:yablogs=\"urn:yandex-blogs\" xmlns:wfw=\"http://wellformedweb.org/CommentAPI/\" version=\"2.0\">\n  <channel>\n    <link>https://yandex.ru/blogs/rss/search?numdoc=10&amp;text=livejournal</link>\n    <title>livejournal — Яндекс.Поиск по блогам</title>\n    <image>\n      <url>https://img.yandex.net/i/logo100x43.png</url>\n      <title>Поиск Яндекса по блогам</title>\n      <link>https://yandex.ru/blogs</link>\n      <width>100</width>\n      <height>43</height>\n    </image>\n    <ttl>60</ttl>\n    <generator>yandex.ru/blogs</generator>\n    <webMaster>support@blogs.yandex.ru</webMaster>\n    <copyright>noindex</copyright>\n    <description>Результаты поиска Яндекса по блогам и форумам по запросу: «livejournal»</description>\n    <yablogs:count>255899</yablogs:count>\n    <yablogs:more>https://yandex.ru/blogs/rss/search?p=1&amp;text=livejournal&amp;numdoc=10</yablogs:more>\n    <item>\n      <author>http://yana-igraeva.__DOMAIN__.com/</author>\n      <yablogs:author>yana_igraeva</yablogs:author>\n      <title>http://banguerski-alex.__DOMAIN__.com/289247.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:08:11 GMT</pubDate>\n      <guid>http://yana-igraeva.__DOMAIN__.com/1009665.html</guid>\n      <link>http://yana-igraeva.__DOMAIN__.com/1009665.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fyana-igraeva.__DOMAIN__.com%2F1009665.html</wfw:commentRss>\n      <yablogs:journal url=\"http://yana-igraeva.__DOMAIN__.com/\">yana_igraeva</yablogs:journal>\n      <description>http://banguerski-alex.&lt;b&gt;livejournal&lt;/b&gt;.com/289247.html.</description>\n    </item>\n    <item>\n      <author>http://arpadhaizy.__DOMAIN__.com/</author>\n      <yablogs:author>arpadhaizy</yablogs:author>\n      <title>http://karhu53.__DOMAIN__.com/23920439.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:07:48 GMT</pubDate>\n      <guid>http://arpadhaizy.__DOMAIN__.com/6519850.html</guid>\n      <link>http://arpadhaizy.__DOMAIN__.com/6519850.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Farpadhaizy.__DOMAIN__.com%2F6519850.html</wfw:commentRss>\n      <yablogs:journal url=\"http://arpadhaizy.__DOMAIN__.com/\">arpadhaizy</yablogs:journal>\n      <description>http://karhu53.&lt;b&gt;livejournal&lt;/b&gt;.com/23920439.html.</description>\n    </item>\n    <item>\n      <author>http://pirandger.__DOMAIN__.com/</author>\n      <yablogs:author>pirandger</yablogs:author>\n      <title>http://prosevbout.__DOMAIN__.com/8263.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:07:27 GMT</pubDate>\n      <guid>http://pirandger.__DOMAIN__.com/7660.html</guid>\n      <link>http://pirandger.__DOMAIN__.com/7660.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fpirandger.__DOMAIN__.com%2F7660.html</wfw:commentRss>\n      <yablogs:journal url=\"http://pirandger.__DOMAIN__.com/\">pirandger</yablogs:journal>\n      <description>http://prosevbout.&lt;b&gt;livejournal&lt;/b&gt;.com/8263.html.</description>\n    </item>\n    <item>\n      <author>http://tranuctool.__DOMAIN__.com/</author>\n      <yablogs:author>tranuctool</yablogs:author>\n      <title>http://prosevbout.__DOMAIN__.com/8263.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:07:27 GMT</pubDate>\n      <guid>http://tranuctool.__DOMAIN__.com/8573.html</guid>\n      <link>http://tranuctool.__DOMAIN__.com/8573.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Ftranuctool.__DOMAIN__.com%2F8573.html</wfw:commentRss>\n      <yablogs:journal url=\"http://tranuctool.__DOMAIN__.com/\">tranuctool</yablogs:journal>\n      <description>http://prosevbout.&lt;b&gt;livejournal&lt;/b&gt;.com/8263.html.</description>\n    </item>\n    <item>\n      <author>http://ciomembre.__DOMAIN__.com/</author>\n      <yablogs:author>ciomembre</yablogs:author>\n      <title>http://topbcuson.__DOMAIN__.com/6981.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:07:26 GMT</pubDate>\n      <guid>http://ciomembre.__DOMAIN__.com/6632.html</guid>\n      <link>http://ciomembre.__DOMAIN__.com/6632.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fciomembre.__DOMAIN__.com%2F6632.html</wfw:commentRss>\n      <yablogs:journal url=\"http://ciomembre.__DOMAIN__.com/\">ciomembre</yablogs:journal>\n      <description>http://topbcuson.&lt;b&gt;livejournal&lt;/b&gt;.com/6981.html.</description>\n    </item>\n    <item>\n      <author>http://trance-se.__DOMAIN__.com/</author>\n      <yablogs:author>trance_se</yablogs:author>\n      <title>http://gur-ar.__DOMAIN__.com/276255.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:07:08 GMT</pubDate>\n      <guid>http://trance-se.__DOMAIN__.com/731962.html</guid>\n      <link>http://trance-se.__DOMAIN__.com/731962.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Ftrance-se.__DOMAIN__.com%2F731962.html</wfw:commentRss>\n      <yablogs:journal url=\"http://trance-se.__DOMAIN__.com/\">trance_se</yablogs:journal>\n      <description>http://gur-ar.&lt;b&gt;livejournal&lt;/b&gt;.com/276255.html.</description>\n    </item>\n    <item>\n      <author>http://ljmosobl.__DOMAIN__.com/</author>\n      <yablogs:author>ljmosobl</yablogs:author>\n      <title>http://mosobl.__DOMAIN__.com/373888.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:06:55 GMT</pubDate>\n      <guid>http://ljmosobl.__DOMAIN__.com/358855.html</guid>\n      <link>http://ljmosobl.__DOMAIN__.com/358855.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fljmosobl.__DOMAIN__.com%2F358855.html</wfw:commentRss>\n      <yablogs:journal url=\"http://ljmosobl.__DOMAIN__.com/\">ljmosobl</yablogs:journal>\n      <description>http://mosobl.&lt;b&gt;livejournal&lt;/b&gt;.com/373888.html.</description>\n    </item>\n    <item>\n      <author>http://putin-dictator.__DOMAIN__.com/</author>\n      <yablogs:author>putin_dictator</yablogs:author>\n      <title>Пора Путину бояться /// ликвидация элиты.</title>\n      <pubDate>Fri, 31 Mar 2017 15:06:50 GMT</pubDate>\n      <guid>http://putin-dictator.__DOMAIN__.com/856.html</guid>\n      <link>http://putin-dictator.vk.com/856.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fputin-dictator.__DOMAIN__.com%2F856.html</wfw:commentRss>\n      <yablogs:journal url=\"http://putin-dictator.__DOMAIN__.com/\">putin_dictator</yablogs:journal>\n      <description>http://dictator-putin.&lt;b&gt;livejournal&lt;/b&gt;.com.</description>\n    </item>\n    <item>\n      <author>http://quetrinat.__DOMAIN__.com/</author>\n      <yablogs:author>quetrinat</yablogs:author>\n      <title>http://satorbull.__DOMAIN__.com/6511.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:06:28 GMT</pubDate>\n      <guid>http://quetrinat.__DOMAIN__.com/6609.html</guid>\n      <link>http://quetrinat.vk.com/6609.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fquetrinat.__DOMAIN__.com%2F6609.html</wfw:commentRss>\n      <yablogs:journal url=\"http://quetrinat.__DOMAIN__.com/\">quetrinat</yablogs:journal>\n      <description>http://satorbull.&lt;b&gt;livejournal&lt;/b&gt;.com/6511.html.</description>\n    </item>\n    <item>\n      <author>http://darrimoun.__DOMAIN__.com/</author>\n      <yablogs:author>darrimoun</yablogs:author>\n      <title>http://acchiegsol.__DOMAIN__.com/8084.html</title>\n      <pubDate>Fri, 31 Mar 2017 15:06:27 GMT</pubDate>\n      <guid>http://darrimoun.__DOMAIN__.com/7323.html</guid>\n      <link>http://darrimoun.example.com/7323.html</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fdarrimoun.__DOMAIN__.com%2F7323.html</wfw:commentRss>\n      <yablogs:journal url=\"http://darrimoun.__DOMAIN__.com/\">darrimoun</yablogs:journal>\n      <description>http://acchiegsol.&lt;b&gt;livejournal&lt;/b&gt;.com/8084.html.</description>\n    </item>\n  </channel>\n</rss>")

;;; Ответ, в котором повторяются ссылки
(def response-repeated "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<rss xmlns:yablogs=\"urn:yandex-blogs\" xmlns:wfw=\"http://wellformedweb.org/CommentAPI/\" version=\"2.0\">\n  <channel>\n    <link>https://yandex.ru/blogs/rss/search?numdoc=10&amp;text=puppy</link>\n    <title>puppy — Яндекс.Поиск по блогам</title>\n    <image>\n      <url>https://img.yandex.net/i/logo100x43.png</url>\n      <title>Поиск Яндекса по блогам</title>\n      <link>https://yandex.ru/blogs</link>\n      <width>100</width>\n      <height>43</height>\n    </image>\n    <ttl>60</ttl>\n    <generator>yandex.ru/blogs</generator>\n    <webMaster>support@blogs.yandex.ru</webMaster>\n    <copyright>noindex</copyright>\n    <description>Результаты поиска Яндекса по блогам и форумам по запросу: «puppy»</description>\n    <yablogs:count>9064</yablogs:count>\n    <yablogs:more>https://yandex.ru/blogs/rss/search?p=1&amp;text=puppy&amp;numdoc=10</yablogs:more>\n    <item>\n      <yablogs:author>puppy_russia</yablogs:author>\n      <title>Москва и область. Щенки, 3 месяца. Глория - малышка, самая...</title>\n      <pubDate>Fri, 31 Mar 2017 14:22:42 GMT</pubDate>\n      <guid>http://vk.com/wall-111673181_5834</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall-111673181_5834</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/club111673181\">Puppy Russia</yablogs:journal>\n      <description>Михаил, +7 985 774 0726. #&lt;b&gt;puppy&lt;/b&gt;_russia#dog#&lt;b&gt;puppy&lt;/b&gt;#adoptme#friend#amazing#like#picoftheday#instadaily#rescue#...</description>\n    </item>\n    <item>\n      <yablogs:author>gothicnotes</yablogs:author>\n      <title>[ :SITD: ] Группа основана весной 1996 года. Название...</title>\n      <pubDate>Fri, 31 Mar 2017 14:19:28 GMT</pubDate>\n      <guid>http://vk.com/wall-54023030_5764</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall-54023030_5764</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/club54023030\">Gothic Notes</yablogs:journal>\n      <description>Апокалиптический электро-ebm-индастриал с вокалом в духе Skinny &lt;b&gt;Puppy&lt;/b&gt; и злободневными текстами. #GothicNotes_Music.</description>\n    </item>\n    <item>\n      <yablogs:author>martsella</yablogs:author>\n      <title>Тайский риджбек щенки - Thai Ridgeback Puppies - продаются - for...</title>\n      <pubDate>Fri, 31 Mar 2017 14:04:41 GMT</pubDate>\n      <guid>http://vk.com/wall38823909_8304</guid>\n      <link>http://vk.com/wall38823909_8304</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall38823909_8304</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id38823909\">Марцелла Голубева</yablogs:journal>\n      <description>Тайский риджбек щенки - Thai Ridgeback &lt;b&gt;Puppies&lt;/b&gt; - продаются - for sale.</description>\n    </item>\n    <item>\n      <yablogs:author>lovedog_vlg</yablogs:author>\n      <title>Счастливая мать \uD83D\uDE0D\uD83D\uDC3E\uD83D\uDC3E #ялайка #ялайкакима #мать #щенки...</title>\n      <pubDate>Fri, 31 Mar 2017 14:02:23 GMT</pubDate>\n      <guid>http://vk.com/wall24270552_8550</guid>\n      <link>http://vk.com/wall24270552_8550</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall24270552_8550</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id24270552\">Евгений Еременко</yablogs:journal>\n      <description>Счастливая мать \uD83D\uDE0D\uD83D\uDC3E\uD83D\uDC3E #ялайка #ялайкакима #мать #щенки #щенкиростов #щенкимосква #щенкиволгоград #щенкикраснодар #&lt;b&gt;puppy&lt;/b&gt; #puppyvolgograd #volgograd #волгоград...</description>\n    </item>\n    <item>\n      <author>http://vk.com/id378476025</author>\n      <yablogs:author>Amanda Boehme</yablogs:author>\n      <title>Thank you Wisdom Panel for your Canine DNA test results for our dog...</title>\n      <pubDate>Fri, 31 Mar 2017 13:57:41 GMT</pubDate>\n      <guid>http://vk.com/wall378476025_727</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall378476025_727</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id378476025\">Amanda Boehme</yablogs:journal>\n      <description>After all this time, we have discovered that Gracie is not a Poodle Mix but a Bichon Frise, Cavalier King Charles Spaniel mix. She is still the adorable, sassy and sweet &lt;b&gt;puppy&lt;/b&gt; that we know and love!</description>\n    </item>\n    <item>\n      <author>http://vk.com/id181173208</author>\n      <yablogs:author>Нина Михайлова</yablogs:author>\n      <title>Puppy of the Siberian Husky with Easter eggs.</title>\n      <pubDate>Fri, 31 Mar 2017 13:56:52 GMT</pubDate>\n      <guid>http://vk.com/wall181173208_1029</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall181173208_1029</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id181173208\">Нина Михайлова</yablogs:journal>\n      <description>&lt;b&gt;Puppy&lt;/b&gt; of the Siberian Husky with Easter eggs.</description>\n    </item>\n    <item>\n      <author>http://vk.com/id144762868</author>\n      <yablogs:author>Наталья Шумилова</yablogs:author>\n      <title>Our beautiful Jeanne. Not for sale. On sale there are puppies.</title>\n      <pubDate>Fri, 31 Mar 2017 13:44:49 GMT</pubDate>\n      <guid>http://vk.com/wall144762868_2170</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall144762868_2170</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id144762868\">Наталья Шумилова</yablogs:journal>\n      <description>Not for sale. On sale there are &lt;b&gt;puppies&lt;/b&gt;. #ПомеранскийШпиц #ПитомникШпицев #ЩенкиШпица: Наша красавица Жанна, не продается.</description>\n    </item>\n    <item>\n      <author>http://vk.com/id144762868</author>\n      <yablogs:author>Наталья Шумилова</yablogs:author>\n      <title>Our beautiful Jeanne. Not for sale. On sale there are puppies.</title>\n      <pubDate>Fri, 31 Mar 2017 13:44:49 GMT</pubDate>\n      <guid>http://vk.com/wall144762868_2169</guid>\n      <link>http://vk.com/wall144762868_2169</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall144762868_2169</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id144762868\">Наталья Шумилова</yablogs:journal>\n      <description>Not for sale. On sale there are &lt;b&gt;puppies&lt;/b&gt;. #ПомеранскийШпиц #ПитомникШпицев #ЩенкиШпица: Наша красавица Жанна, не продается.</description>\n    </item>\n    <item>\n      <author>http://vk.com/id228899486</author>\n      <yablogs:author>Татьяна Галаничева</yablogs:author>\n      <title>Питерский рассвет. \uD83C\uDF05 #рассвет #весна #тепло #солнце #собака...</title>\n      <pubDate>Fri, 31 Mar 2017 13:38:56 GMT</pubDate>\n      <guid>http://vk.com/wall228899486_1365</guid>\n      <link>http://vk.com/wall228899486_1365</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall228899486_1365</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id228899486\">Татьяна Галаничева</yablogs:journal>\n      <description>...jackrussellworld #jackrussellterrier #cute #love #джекрасселтерьер #джекрассел #jrt #jackrussell #dog #&lt;b&gt;puppy&lt;/b&gt; #puppylove.</description>\n    </item>\n    <item>\n      <yablogs:author>priut_ivanovo</yablogs:author>\n      <title>Не так давно этот гончий бегал в Буньково, потом а районе...</title>\n      <pubDate>Fri, 31 Mar 2017 13:36:39 GMT</pubDate>\n      <guid>http://vk.com/wall60302958_9670</guid>\n      <link>http://vk.com/wall60302958_9670</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall60302958_9670</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id60302958\">Наталья Богданова</yablogs:journal>\n      <description>Сёма-2 #счастливаяистория #dog #dog #&lt;b&gt;puppy&lt;/b&gt; #pup #TagsForLikes #cute #eyes #instagood #dogs_of_instagram #pet #pets #animal #animals #petstagram #petsagram #dogsitting...</description>\n    </item>\n  </channel>\n</rss>\n")

;;; Ответ, в котором нет блогов
(def response-empty "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<rss xmlns:yablogs=\"urn:yandex-blogs\" xmlns:wfw=\"http://wellformedweb.org/CommentAPI/\" version=\"2.0\">\n  <channel>\n    <link>https://yandex.ru/blogs/rss/search?numdoc=10&amp;text=puppy</link>\n    <title>puppy — Яндекс.Поиск по блогам</title>\n    <image>\n      <url>https://img.yandex.net/i/logo100x43.png</url>\n      <title>Поиск Яндекса по блогам</title>\n      <link>https://yandex.ru/blogs</link>\n      <width>100</width>\n      <height>43</height>\n    </image>\n    <ttl>60</ttl>\n    <generator>yandex.ru/blogs</generator>\n    <webMaster>support@blogs.yandex.ru</webMaster>\n    <copyright>noindex</copyright>\n    <description>Результаты поиска Яндекса по блогам и форумам по запросу: «puppy»</description>\n    <yablogs:count>0</yablogs:count>\n    <yablogs:more>https://yandex.ru/blogs/rss/search?p=1&amp;text=puppy&amp;numdoc=10</yablogs:more>\n  </channel>\n</rss>\n")


(defn server-handler
  "Обработчик входящих запросов."
  [request]
  (let [text (-> request :query-params (get "text"))]
    {:status 200
     :headers {"Content-Type" "text/html"}
     :body (condp = text
             "repeated" response-repeated
             "not-found" response-empty
             (string/replace response "__DOMAIN__" text))}))


(defn start
  "Запуск сервера."
  []
  (server/run-server (middleware/wrap-defaults server-handler middleware/api-defaults) {:port (settings/get-setting :testing-server-port)}))
