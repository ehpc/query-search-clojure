(ns query-search.stat-test
  (:require [clojure.test :refer :all]
            [query-search.stat :refer :all]))

;; XML, в котором повторяются ссылки.
(def repeated-xml "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<rss xmlns:yablogs=\"urn:yandex-blogs\" xmlns:wfw=\"http://wellformedweb.org/CommentAPI/\" version=\"2.0\">\n  <channel>\n    <link>https://yandex.ru/blogs/rss/search?numdoc=10&amp;text=puppy</link>\n    <title>puppy — Яндекс.Поиск по блогам</title>\n    <image>\n      <url>https://img.yandex.net/i/logo100x43.png</url>\n      <title>Поиск Яндекса по блогам</title>\n      <link>https://yandex.ru/blogs</link>\n      <width>100</width>\n      <height>43</height>\n    </image>\n    <ttl>60</ttl>\n    <generator>yandex.ru/blogs</generator>\n    <webMaster>support@blogs.yandex.ru</webMaster>\n    <copyright>noindex</copyright>\n    <description>Результаты поиска Яндекса по блогам и форумам по запросу: «puppy»</description>\n    <yablogs:count>9064</yablogs:count>\n    <yablogs:more>https://yandex.ru/blogs/rss/search?p=1&amp;text=puppy&amp;numdoc=10</yablogs:more>\n    <item>\n      <yablogs:author>puppy_russia</yablogs:author>\n      <title>Москва и область. Щенки, 3 месяца. Глория - малышка, самая...</title>\n      <pubDate>Fri, 31 Mar 2017 14:22:42 GMT</pubDate>\n      <guid>http://vk.com/wall-111673181_5834</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall-111673181_5834</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/club111673181\">Puppy Russia</yablogs:journal>\n      <description>Михаил, +7 985 774 0726. #&lt;b&gt;puppy&lt;/b&gt;_russia#dog#&lt;b&gt;puppy&lt;/b&gt;#adoptme#friend#amazing#like#picoftheday#instadaily#rescue#...</description>\n    </item>\n    <item>\n      <yablogs:author>gothicnotes</yablogs:author>\n      <title>[ :SITD: ] Группа основана весной 1996 года. Название...</title>\n      <pubDate>Fri, 31 Mar 2017 14:19:28 GMT</pubDate>\n      <guid>http://vk.com/wall-54023030_5764</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall-54023030_5764</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/club54023030\">Gothic Notes</yablogs:journal>\n      <description>Апокалиптический электро-ebm-индастриал с вокалом в духе Skinny &lt;b&gt;Puppy&lt;/b&gt; и злободневными текстами. #GothicNotes_Music.</description>\n    </item>\n    <item>\n      <yablogs:author>martsella</yablogs:author>\n      <title>Тайский риджбек щенки - Thai Ridgeback Puppies - продаются - for...</title>\n      <pubDate>Fri, 31 Mar 2017 14:04:41 GMT</pubDate>\n      <guid>http://vk.com/wall38823909_8304</guid>\n      <link>http://vk.com/wall38823909_8304</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall38823909_8304</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id38823909\">Марцелла Голубева</yablogs:journal>\n      <description>Тайский риджбек щенки - Thai Ridgeback &lt;b&gt;Puppies&lt;/b&gt; - продаются - for sale.</description>\n    </item>\n    <item>\n      <yablogs:author>lovedog_vlg</yablogs:author>\n      <title>Счастливая мать \uD83D\uDE0D\uD83D\uDC3E\uD83D\uDC3E #ялайка #ялайкакима #мать #щенки...</title>\n      <pubDate>Fri, 31 Mar 2017 14:02:23 GMT</pubDate>\n      <guid>http://vk.com/wall24270552_8550</guid>\n      <link>http://vk.com/wall24270552_8550</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall24270552_8550</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id24270552\">Евгений Еременко</yablogs:journal>\n      <description>Счастливая мать \uD83D\uDE0D\uD83D\uDC3E\uD83D\uDC3E #ялайка #ялайкакима #мать #щенки #щенкиростов #щенкимосква #щенкиволгоград #щенкикраснодар #&lt;b&gt;puppy&lt;/b&gt; #puppyvolgograd #volgograd #волгоград...</description>\n    </item>\n    <item>\n      <author>http://vk.com/id378476025</author>\n      <yablogs:author>Amanda Boehme</yablogs:author>\n      <title>Thank you Wisdom Panel for your Canine DNA test results for our dog...</title>\n      <pubDate>Fri, 31 Mar 2017 13:57:41 GMT</pubDate>\n      <guid>http://vk.com/wall378476025_727</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall378476025_727</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id378476025\">Amanda Boehme</yablogs:journal>\n      <description>After all this time, we have discovered that Gracie is not a Poodle Mix but a Bichon Frise, Cavalier King Charles Spaniel mix. She is still the adorable, sassy and sweet &lt;b&gt;puppy&lt;/b&gt; that we know and love!</description>\n    </item>\n    <item>\n      <author>http://vk.com/id181173208</author>\n      <yablogs:author>Нина Михайлова</yablogs:author>\n      <title>Puppy of the Siberian Husky with Easter eggs.</title>\n      <pubDate>Fri, 31 Mar 2017 13:56:52 GMT</pubDate>\n      <guid>http://vk.com/wall181173208_1029</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall181173208_1029</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id181173208\">Нина Михайлова</yablogs:journal>\n      <description>&lt;b&gt;Puppy&lt;/b&gt; of the Siberian Husky with Easter eggs.</description>\n    </item>\n    <item>\n      <author>http://vk.com/id144762868</author>\n      <yablogs:author>Наталья Шумилова</yablogs:author>\n      <title>Our beautiful Jeanne. Not for sale. On sale there are puppies.</title>\n      <pubDate>Fri, 31 Mar 2017 13:44:49 GMT</pubDate>\n      <guid>http://vk.com/wall144762868_2170</guid>\n      <link>http://repeated5times.com/page</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall144762868_2170</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id144762868\">Наталья Шумилова</yablogs:journal>\n      <description>Not for sale. On sale there are &lt;b&gt;puppies&lt;/b&gt;. #ПомеранскийШпиц #ПитомникШпицев #ЩенкиШпица: Наша красавица Жанна, не продается.</description>\n    </item>\n    <item>\n      <author>http://vk.com/id144762868</author>\n      <yablogs:author>Наталья Шумилова</yablogs:author>\n      <title>Our beautiful Jeanne. Not for sale. On sale there are puppies.</title>\n      <pubDate>Fri, 31 Mar 2017 13:44:49 GMT</pubDate>\n      <guid>http://vk.com/wall144762868_2169</guid>\n      <link>http://vk.com/wall144762868_2169</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall144762868_2169</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id144762868\">Наталья Шумилова</yablogs:journal>\n      <description>Not for sale. On sale there are &lt;b&gt;puppies&lt;/b&gt;. #ПомеранскийШпиц #ПитомникШпицев #ЩенкиШпица: Наша красавица Жанна, не продается.</description>\n    </item>\n    <item>\n      <author>http://vk.com/id228899486</author>\n      <yablogs:author>Татьяна Галаничева</yablogs:author>\n      <title>Питерский рассвет. \uD83C\uDF05 #рассвет #весна #тепло #солнце #собака...</title>\n      <pubDate>Fri, 31 Mar 2017 13:38:56 GMT</pubDate>\n      <guid>http://vk.com/wall228899486_1365</guid>\n      <link>http://vk.com/wall228899486_1365</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall228899486_1365</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id228899486\">Татьяна Галаничева</yablogs:journal>\n      <description>...jackrussellworld #jackrussellterrier #cute #love #джекрасселтерьер #джекрассел #jrt #jackrussell #dog #&lt;b&gt;puppy&lt;/b&gt; #puppylove.</description>\n    </item>\n    <item>\n      <yablogs:author>priut_ivanovo</yablogs:author>\n      <title>Не так давно этот гончий бегал в Буньково, потом а районе...</title>\n      <pubDate>Fri, 31 Mar 2017 13:36:39 GMT</pubDate>\n      <guid>http://vk.com/wall60302958_9670</guid>\n      <link>http://vk.com/wall60302958_9670</link>\n      <wfw:commentRss>https://yandex.ru/blogs/rss/search?post=http%3A%2F%2Fvk.com%2Fwall60302958_9670</wfw:commentRss>\n      <yablogs:journal url=\"http://vk.com/id60302958\">Наталья Богданова</yablogs:journal>\n      <description>Сёма-2 #счастливаяистория #dog #dog #&lt;b&gt;puppy&lt;/b&gt; #pup #TagsForLikes #cute #eyes #instagood #dogs_of_instagram #pet #pets #animal #animals #petstagram #petsagram #dogsitting...</description>\n    </item>\n  </channel>\n</rss>\n")

;; XML, в котором нет блогов
(def empty-xml "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<rss xmlns:yablogs=\"urn:yandex-blogs\" xmlns:wfw=\"http://wellformedweb.org/CommentAPI/\" version=\"2.0\">\n  <channel>\n    <link>https://yandex.ru/blogs/rss/search?numdoc=10&amp;text=puppy</link>\n    <title>puppy — Яндекс.Поиск по блогам</title>\n    <image>\n      <url>https://img.yandex.net/i/logo100x43.png</url>\n      <title>Поиск Яндекса по блогам</title>\n      <link>https://yandex.ru/blogs</link>\n      <width>100</width>\n      <height>43</height>\n    </image>\n    <ttl>60</ttl>\n    <generator>yandex.ru/blogs</generator>\n    <webMaster>support@blogs.yandex.ru</webMaster>\n    <copyright>noindex</copyright>\n    <description>Результаты поиска Яндекса по блогам и форумам по запросу: «puppy»</description>\n    <yablogs:count>0</yablogs:count>\n    <yablogs:more>https://yandex.ru/blogs/rss/search?p=1&amp;text=puppy&amp;numdoc=10</yablogs:more>\n  </channel>\n</rss>\n")

(deftest stat-test
  "Статистика по доменам из поиска по блогам."
  (testing "Сценарий: Статистика по одному ключевому слову при первом запуске."
    (is
      (> (get @(get-domain-stats-for-blogs ["scala"]) "scala.com") 3)
      "Домен scala.com встречается больше 3 раз."))
  (testing "Сценарий: Статистика по одному ключевому слову при повторном запросе."
    (is
      (> (get @(get-domain-stats-for-blogs ["scala"]) "scala.com") 3)
      "Домен scala.com встречается больше 3 раз."))
  (testing "Сценарий: Статистика по другому ключевому слову."
    (is
      (> (get @(get-domain-stats-for-blogs ["bdd"]) "bdd.com") 3)
      "Домен bdd.com встречается больше 3 раз."))
  (testing "Сценарий: Статистика по двум запросам сразу."
    (is
      (let [stats @(get-domain-stats-for-blogs ["puppy" "kitty"])]
        (and
          (> (get stats "puppy.com") 3)
          (> (get stats "kitty.com") 3)))
      "Домены puppy.com и kitty.com встречаются больше 3 раз каждый."))
  (testing "Сценарий: Запрос с русскими буквами."
    (is
      (> (get @(get-domain-stats-for-blogs ["запрос"]) "vk.com") 1)
      "Домен vk.com встречается больше 1 раза."))
  (testing "Сценарий: Запрос с повторяющимися ссылками в ответе API Yandex"
    (is
      (= (get @(get-domain-stats-for-blogs ["повтор"] [repeated-xml repeated-xml]) "repeated5times.com" 1))
      "Домен repeated5times.com встречается ровно 1 раз."))
  (testing "Адекватная реакция, когда блогов не найдено."
    (is
      (empty? @(get-domain-stats-for-blogs ["не-найдено"] [empty-xml]))
      "Список доменов пустой.")))
